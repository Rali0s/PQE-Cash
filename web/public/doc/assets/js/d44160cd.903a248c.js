"use strict";(self.webpackChunkbluearc_tiger_docs=self.webpackChunkbluearc_tiger_docs||[]).push([[309],{5714(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"legacy/relayer-api","title":"3. Relayer API with PQ-Hybrid Handshake","description":"Base URL:","source":"@site/docs/legacy/03-relayer-api.md","sourceDirName":"legacy","slug":"/legacy/relayer-api","permalink":"/doc/docs/legacy/relayer-api","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"2. Exact Public/Private Signal Schema","permalink":"/doc/docs/legacy/circuit-signal-schema"},"next":{"title":"4. BlueARC Product Spec","permalink":"/doc/docs/legacy/product-spec"}}');var r=s(4848),d=s(8453);const l={},c="3. Relayer API with PQ-Hybrid Handshake",o={},t=[{value:"Transport + Security",id:"transport--security",level:2},{value:"<code>GET /health</code>",id:"get-health",level:2},{value:"<code>GET /config</code>",id:"get-config",level:2},{value:"<code>GET /metrics</code>",id:"get-metrics",level:2},{value:"<code>GET /handshake/server-key</code>",id:"get-handshakeserver-key",level:2},{value:"<code>POST /handshake/open</code>",id:"post-handshakeopen",level:2},{value:"<code>POST /quote</code>",id:"post-quote",level:2},{value:"<code>POST /submit</code>",id:"post-submit",level:2},{value:"<code>GET /status/:jobId</code>",id:"get-statusjobid",level:2},{value:"Anti-Tamper + Replay Controls",id:"anti-tamper--replay-controls",level:2},{value:"Abuse Controls",id:"abuse-controls",level:2},{value:"Signer Modes",id:"signer-modes",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"3-relayer-api-with-pq-hybrid-handshake",children:"3. Relayer API with PQ-Hybrid Handshake"})}),"\n",(0,r.jsx)(n.p,{children:"Base URL:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Development: ",(0,r.jsx)(n.code,{children:"http://127.0.0.1:8080"})]}),"\n",(0,r.jsxs)(n.li,{children:["Production: ",(0,r.jsx)(n.code,{children:"https://<relayer-host>"})," (TLS required, optional mTLS)"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"transport--security",children:"Transport + Security"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"TLS_CERT_PATH"})," + ",(0,r.jsx)(n.code,{children:"TLS_KEY_PATH"})," enable HTTPS listener."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"TLS_REQUIRE_CLIENT_CERT=true"})," + ",(0,r.jsx)(n.code,{children:"TLS_CA_PATH"})," enforce mTLS."]}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"NODE_ENV=production"}),", set TLS or explicitly allow insecure mode via ",(0,r.jsx)(n.code,{children:"ALLOW_INSECURE_HTTP=true"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Sessions, nonce replay windows, and abuse/rate-limit counters are persisted in Redis."}),"\n",(0,r.jsx)(n.li,{children:"Quotes and jobs are persisted in Postgres."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"get-health",children:(0,r.jsx)(n.code,{children:"GET /health"})}),"\n",(0,r.jsx)(n.p,{children:"Dependency readiness check."}),"\n",(0,r.jsx)(n.p,{children:"Response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "ok": true,\n  "chainId": 31337,\n  "signer": "0x...",\n  "pqKemAlgorithm": "ML-KEM-768",\n  "minFeeBps": 50,\n  "maxFeeBps": 300,\n  "requiredProofVersion": "bluearc-v2",\n  "defaultPool": "0x...",\n  "poolVersion": "v2",\n  "deployConfigLoadedAt": 1735689480000\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"get-config",children:(0,r.jsx)(n.code,{children:"GET /config"})}),"\n",(0,r.jsx)(n.p,{children:"Runtime public config payload (same metadata subset used by frontend bootstrap)."}),"\n",(0,r.jsx)(n.h2,{id:"get-metrics",children:(0,r.jsx)(n.code,{children:"GET /metrics"})}),"\n",(0,r.jsx)(n.p,{children:"Prometheus metrics endpoint."}),"\n",(0,r.jsx)(n.h2,{id:"get-handshakeserver-key",children:(0,r.jsx)(n.code,{children:"GET /handshake/server-key"})}),"\n",(0,r.jsx)(n.p,{children:"Returns active hybrid key material metadata (ECDH + ML-KEM-768 public key)."}),"\n",(0,r.jsx)(n.p,{children:"Response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "keyId": "uuid",\n  "curve": "prime256v1",\n  "serverEcdhPublicKey": "base64",\n  "pqKemAlgorithm": "ML-KEM-768",\n  "pqKemPublicKey": "base64",\n  "pqKemCiphertextBytes": 1088,\n  "expiresAt": 1735689600000\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"post-handshakeopen",children:(0,r.jsx)(n.code,{children:"POST /handshake/open"})}),"\n",(0,r.jsx)(n.p,{children:"Creates a short-lived encrypted session."}),"\n",(0,r.jsx)(n.p,{children:"Request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "keyId": "uuid (optional)",\n  "clientEcdhPublicKey": "base64",\n  "pqKemCiphertext": "base64"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Session key schedule (V2):\n",(0,r.jsx)(n.code,{children:'session_key = SHA256("BLUEARC_HYBRID_MLKEM_V1" || len(keyId) || keyId || len(client_ecdh_pub) || client_ecdh_pub || len(server_ecdh_pub) || server_ecdh_pub || len(pq_kem_ciphertext) || pq_kem_ciphertext || len(classical_ecdh_secret) || classical_ecdh_secret || len(ml_kem_shared_secret) || ml_kem_shared_secret)'})]}),"\n",(0,r.jsx)(n.p,{children:"Response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "sessionId": "uuid",\n  "expiresInSec": 600,\n  "keySchedule": "sha256(bluearc_hybrid_mlkem_v1 transcript)",\n  "submitMode": "encrypted-envelope-v1"\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"post-quote",children:(0,r.jsx)(n.code,{children:"POST /quote"})}),"\n",(0,r.jsx)(n.p,{children:"Requests relayer quote."}),"\n",(0,r.jsx)(n.p,{children:"Request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "pool": "0x...",\n  "feeBps": 80\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "quote": {\n    "quoteId": "uuid",\n    "pool": "0x...",\n    "feeBps": 80,\n    "fee": "1000000000000000",\n    "chainId": 31337,\n    "expiresAt": 1735689600000,\n    "issuedAt": 1735689480000\n  },\n  "quoteSignature": "0x...",\n  "ttlSec": 120,\n  "signer": "0x...",\n  "requestedFeeBps": 50,\n  "baseRelayerFee": "1000000000000000",\n  "minFeeBpsForPool": 100\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Notes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Relayer enforces pool base fee floor by adjusting effective quote fee/bps upward when needed."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"post-submit",children:(0,r.jsx)(n.code,{children:"POST /submit"})}),"\n",(0,r.jsx)(n.p,{children:"Submits an encrypted withdrawal payload."}),"\n",(0,r.jsx)(n.p,{children:"Request:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "sessionId": "uuid",\n  "envelope": {\n    "iv": "base64",\n    "ciphertext": "base64",\n    "tag": "base64",\n    "aad": "sessionId"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Decrypted payload:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "nonce": "uuid-v4",\n  "expiresAt": 1735689600000,\n  "quote": {\n    "quoteId": "uuid",\n    "pool": "0x...",\n    "feeBps": 80,\n    "fee": "1000000000000000",\n    "chainId": 31337,\n    "expiresAt": 1735689600000\n  },\n  "quoteSignature": "0x...",\n  "pool": "0x...",\n  "proofVersion": "bluearc-v2",\n  "proof": "0x...",\n  "root": "0x...",\n  "nullifierHash": "0x...",\n  "recipient": "0x...",\n  "refund": "0"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Response:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "jobId": "uuid",\n  "txHash": "0x...",\n  "status": "pending"\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"get-statusjobid",children:(0,r.jsx)(n.code,{children:"GET /status/:jobId"})}),"\n",(0,r.jsx)(n.p,{children:"Returns one of:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"queued"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"broadcasting"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"pending"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"confirmed"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"failed"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"anti-tamper--replay-controls",children:"Anti-Tamper + Replay Controls"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Quote digest signed at ",(0,r.jsx)(n.code,{children:"/quote"}),"; verified again at ",(0,r.jsx)(n.code,{children:"/submit"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Encrypted submit requires valid session key + AEAD tag."}),"\n",(0,r.jsxs)(n.li,{children:["Per-session nonce keys persisted with TTL and replay rejection (",(0,r.jsx)(n.code,{children:"409"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Payload expiry bounded by session expiry and configurable max age."}),"\n",(0,r.jsxs)(n.li,{children:["Optional session fingerprint binding (",(0,r.jsx)(n.code,{children:"ENFORCE_SESSION_BINDING=true"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"abuse-controls",children:"Abuse Controls"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Redis-backed route limits by source."}),"\n",(0,r.jsx)(n.li,{children:"Abuse score buckets with temporary blocking threshold."}),"\n",(0,r.jsxs)(n.li,{children:["Optional pool allowlist (",(0,r.jsx)(n.code,{children:"POOL_ALLOWLIST"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Proof size upper bound (",(0,r.jsx)(n.code,{children:"PROOF_MAX_BYTES"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Optional proof version enforcement (",(0,r.jsx)(n.code,{children:"PROOF_VERSION_REQUIRED"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Optional runtime pool version hint for frontend (",(0,r.jsx)(n.code,{children:"RUNTIME_POOL_VERSION"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"signer-modes",children:"Signer Modes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SIGNER_MODE=local"}),": local private key."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SIGNER_MODE=remote"}),": KMS/HSM service over HTTPS (",(0,r.jsx)(n.code,{children:"/v1/sign-message"}),", ",(0,r.jsx)(n.code,{children:"/v1/sign-transaction"}),")."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const r={},d=i.createContext(r);function l(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);