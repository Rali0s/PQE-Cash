"use strict";(self.webpackChunkbluearc_tiger_docs=self.webpackChunkbluearc_tiger_docs||[]).push([[611],{4809(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"legacy/contract-interfaces-storage","title":"1. Contract Interfaces and Storage Layout","description":"IVerifier","source":"@site/docs/legacy/01-contract-interfaces-storage.md","sourceDirName":"legacy","slug":"/legacy/contract-interfaces-storage","permalink":"/doc/docs/legacy/contract-interfaces-storage","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Release and Incident Runbook","permalink":"/doc/docs/admin/release-and-incident-runbook"},"next":{"title":"2. Exact Public/Private Signal Schema","permalink":"/doc/docs/legacy/circuit-signal-schema"}}');var l=r(4848),c=r(8453);const s={},t="1. Contract Interfaces and Storage Layout",o={},d=[{value:"<code>IVerifier</code>",id:"iverifier",level:2},{value:"<code>PqVerifierAdapter</code>",id:"pqverifieradapter",level:2},{value:"<code>ProtocolTreasury</code>",id:"protocoltreasury",level:2},{value:"<code>PrivacyPool</code>",id:"privacypool",level:2},{value:"Constructor",id:"constructor",level:3},{value:"Public/External Functions",id:"publicexternal-functions",level:3},{value:"Storage Layout",id:"storage-layout",level:3},{value:"Merkle Semantics",id:"merkle-semantics",level:3},{value:"Security Controls",id:"security-controls",level:3},{value:"<code>PoolFactory</code>",id:"poolfactory",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"1-contract-interfaces-and-storage-layout",children:"1. Contract Interfaces and Storage Layout"})}),"\n",(0,l.jsx)(n.h2,{id:"iverifier",children:(0,l.jsx)(n.code,{children:"IVerifier"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"function verifyProof(bytes calldata proof, uint256[] calldata input) external view returns (bool);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"pqverifieradapter",children:(0,l.jsx)(n.code,{children:"PqVerifierAdapter"})}),"\n",(0,l.jsx)(n.p,{children:"Adapter that connects pool verifier calls to an external circuit verifier contract."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"enum BackendType { Bytes, Uint }\n\nconstructor(address externalVerifier_, BackendType backendType_)\nfunction setExternalVerifier(address externalVerifier_) external\nfunction setBackendType(BackendType backendType_) external\nfunction verifyProof(bytes calldata proof, uint256[] calldata input) external view returns (bool)\n"})}),"\n",(0,l.jsx)(n.p,{children:"Storage:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"address public externalVerifier"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"BackendType public backendType"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Behavior:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"BackendType.Bytes"})," calls ",(0,l.jsx)(n.code,{children:"verify(bytes proof, bytes encodedPublicInputs)"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"BackendType.Uint"})," calls ",(0,l.jsx)(n.code,{children:"verifyProof(bytes proof, uint256[] publicInputs)"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"No fallback mode: backend semantics are explicit and owner-controlled."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"protocoltreasury",children:(0,l.jsx)(n.code,{children:"ProtocolTreasury"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"constructor(uint256 withdrawDelay_)\nfunction setWithdrawDelay(uint256 newWithdrawDelay) external\nfunction queueWithdrawal(address payable to, uint256 amount) external returns (uint256 requestId)\nfunction executeWithdrawal(uint256 requestId) external\n"})}),"\n",(0,l.jsx)(n.p,{children:"Storage:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public withdrawDelay"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public nextRequestId"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"mapping(uint256 => WithdrawalRequest) public requests"})}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Guards:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["OpenZeppelin ",(0,l.jsx)(n.code,{children:"Ownable"})]}),"\n",(0,l.jsxs)(n.li,{children:["OpenZeppelin ",(0,l.jsx)(n.code,{children:"ReentrancyGuard"})]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"privacypool",children:(0,l.jsx)(n.code,{children:"PrivacyPool"})}),"\n",(0,l.jsx)(n.h3,{id:"constructor",children:"Constructor"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"constructor(\n  address verifier_,\n  uint256 denomination_,\n  uint256 baseRelayerFee_,\n  uint256 protocolFeeBps_,\n  address payable treasury_\n)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"publicexternal-functions",children:"Public/External Functions"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"function isKnownRoot(bytes32 root) public view returns (bool)\nfunction computeRootFromPath(bytes32 leaf, bytes32[20] calldata siblings, uint32 leafIndex) external pure returns (bytes32)\nfunction verifyMerklePath(bytes32 leaf, bytes32[20] calldata siblings, uint32 leafIndex, bytes32 expectedRoot) external pure returns (bool)\nfunction deposit(bytes32 commitment) external payable\nfunction withdraw(bytes calldata proof, bytes32 root, bytes32 nullifierHash, address payable recipient, address payable relayer, uint256 fee, uint256 refund) external\nfunction setBaseRelayerFee(uint256 newBaseRelayerFee) external\nfunction setProtocolFeeBps(uint256 newProtocolFeeBps) external\nfunction setTreasury(address payable newTreasury) external\nfunction setRelayerOnly(bool enabled) external\nfunction setApprovedRelayersOnly(bool enabled) external\nfunction setRelayerApproval(address relayer, bool approved) external\n"})}),"\n",(0,l.jsx)(n.h3,{id:"storage-layout",children:"Storage Layout"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"IVerifier public immutable verifier"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public immutable denomination"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint32 public nextLeafIndex"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bytes32 public currentRoot"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public depositCount"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public baseRelayerFee"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public protocolFeeBps"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"address payable public treasury"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bool public relayerOnly"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bool public approvedRelayersOnly"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"mapping(address => bool) public approvedRelayers"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"mapping(bytes32 => bool) public commitmentUsed"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"mapping(bytes32 => bool) public nullifierSpent"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"mapping(bytes32 => bool) public rootKnown"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bytes32[100] public rootHistory"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"uint256 public rootHistoryIndex"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bytes32[21] public zeros"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"bytes32[20] public filledSubtrees"})}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"merkle-semantics",children:"Merkle Semantics"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Incremental insert with ",(0,l.jsx)(n.code,{children:"nextLeafIndex"}),", ",(0,l.jsx)(n.code,{children:"zeros"}),", ",(0,l.jsx)(n.code,{children:"filledSubtrees"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["Root history ring-buffer with ",(0,l.jsx)(n.code,{children:"rootKnown"})," membership checks."]}),"\n",(0,l.jsx)(n.li,{children:"Path recomputation helper functions available for off-chain proof tooling/tests."}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"security-controls",children:"Security Controls"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["OpenZeppelin ",(0,l.jsx)(n.code,{children:"Ownable"})," + ",(0,l.jsx)(n.code,{children:"ReentrancyGuard"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"receive()"})," and ",(0,l.jsx)(n.code,{children:"fallback()"})," revert (deposits must use ",(0,l.jsx)(n.code,{children:"deposit"}),")."]}),"\n",(0,l.jsx)(n.li,{children:"Nullifier one-time spend."}),"\n",(0,l.jsxs)(n.li,{children:["Relayer policy switches:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"relayerOnly=true"})," enforces relayer-submitted withdrawals."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"approvedRelayersOnly=true"})," enforces relayer allowlist."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"poolfactory",children:(0,l.jsx)(n.code,{children:"PoolFactory"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-solidity",children:"constructor(address verifier_, address payable treasury_)\nfunction createPool(uint256 denomination, uint256 baseRelayerFee, uint256 protocolFeeBps) external returns (address)\nfunction allPools() external view returns (address[] memory)\n"})}),"\n",(0,l.jsx)(n.p,{children:"Storage:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"address public immutable verifier"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"address payable public immutable treasury"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"address[] public pools"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},8453(e,n,r){r.d(n,{R:()=>s,x:()=>t});var i=r(6540);const l={},c=i.createContext(l);function s(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);