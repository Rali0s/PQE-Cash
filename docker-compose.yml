services:
  postgres:
    image: postgres:16-alpine
    container_name: bluearc-postgres
    environment:
      POSTGRES_DB: bluearc
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d bluearc"]
      interval: 5s
      timeout: 5s
      retries: 20

  redis:
    image: redis:7-alpine
    container_name: bluearc-redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 20

  hardhat:
    build:
      context: ./contracts
    container_name: bluearc-hardhat
    ports:
      - "8545:8545"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"const net=require('net');const s=net.connect(8545,'127.0.0.1',()=>{s.end();process.exit(0)});s.on('error',()=>process.exit(1));\""
        ]
      interval: 5s
      timeout: 5s
      retries: 20

  deployer:
    build:
      context: ./contracts
    container_name: bluearc-deployer
    depends_on:
      hardhat:
        condition: service_healthy
    volumes:
      - deploy-data:/shared
    command: >
      sh -c "
      until node -e \"const net=require('net');const s=net.connect(8545,'hardhat',()=>{s.end();process.exit(0)});s.on('error',()=>process.exit(1));\"; do echo 'waiting for hardhat...'; sleep 1; done;
      ALLOW_DEV_VERIFIER=true DEPLOY_OUTPUT=/shared/deploy.json npx hardhat run scripts/deploy.js --network docker;
      cat /shared/deploy.json"

  relayer:
    build:
      context: ./relayer
    container_name: bluearc-relayer
    depends_on:
      hardhat:
        condition: service_healthy
      deployer:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      PORT: 8080
      HOST: 0.0.0.0
      RPC_URL: http://hardhat:8545
      POSTGRES_URL: postgres://postgres:postgres@postgres:5432/bluearc
      REDIS_URL: redis://redis:6379
      SIGNER_MODE: local
      RELAYER_PRIVATE_KEY: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      MIN_FEE_BPS: 50
      MAX_FEE_BPS: 300
      SESSION_TTL_MS: 600000
      QUOTE_TTL_MS: 120000
      NONCE_TTL_MS: 900000
      PAYLOAD_MAX_AGE_MS: 90000
      QUOTE_REPLAY_WINDOW_MS: 180000
      PROOF_MAX_BYTES: 16384
      RATE_WINDOW_MS: 60000
      RATE_LIMIT_HANDSHAKE: 60
      RATE_LIMIT_QUOTE: 30
      RATE_LIMIT_SUBMIT: 20
      RATE_LIMIT_STATUS: 120
      ABUSE_TTL_MS: 900000
      ABUSE_BLOCK_THRESHOLD: 25
      ENFORCE_SESSION_BINDING: "true"
      ALLOW_INSECURE_HTTP: "true"
      ANON_LOGGING: "true"
      LOG_LEVEL: info
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/health | grep -q '\"ok\":true'"]
      interval: 10s
      timeout: 5s
      retries: 20

  web:
    build:
      context: ./web
    container_name: bluearc-web
    depends_on:
      relayer:
        condition: service_healthy
      deployer:
        condition: service_completed_successfully
    ports:
      - "5173:5173"

volumes:
  deploy-data:
  postgres-data:
  redis-data:
